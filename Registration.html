<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Registration.css">
    <title>Регистрация</title>
</head>
<body>
    <div class="main-container">
        <div class="header-container">
            <h2 class="title">Регистрация</h2>
        </div>
        <div class="register-form">
            <form id="registrationForm">
                <div class="input-group">
                    <input 
                        placeholder="Имя"
                        type="text" 
                        class="input-field"
                        name="name"
                        pattern="^[А-Яа-яЁё\s\-]+$"
                        title="Имя должно содержать только русские буквы, пробелы и дефисы"
                        required
                    />
                </div>
                
                <div class="input-group">
                    <input 
                        placeholder="Фамилия"
                        type="text" 
                        class="input-field"
                        name="surname"
                        pattern="^[А-Яа-яЁё\s\-]+$"
                        title="Фамилия должна содержать только русские буквы, пробелы и дефисы"
                        required
                    />
                </div>
                
                <div class="input-group">
                    <input 
                        placeholder="Отчество"
                        type="text" 
                        class="input-field"
                        name="patronymic"
                        pattern="^[А-Яа-яЁё\s\-]*$"
                        title="Отчество должно содержать только русские буквы, пробелы и дефисы"
                    />
                </div>
                
                <div class="input-group">
                    <input 
                        placeholder="Логин" 
                        type="text" 
                        class="input-field"
                        name="login"
                        pattern="^[A-Za-z0-9]{6,}$"
                        title="Логин должен содержать только английские буквы и цифры, минимум 6 символов"
                        required
                    />
                </div>
                
                <div class="input-group">
                    <input 
                        placeholder="Email" 
                        type="email" 
                        class="input-field"
                        name="email"
                        required
                    />
                </div>

                <div class="input-group">
                    <input 
                        type="tel" 
                        id="phone" 
                        name="phone" 
                        placeholder="8 (999) 123-45-67" 
                        pattern="^8\s?\(\d{3}\)\s?\d{3}-\d{2}-\d{2}$"
                        title="Формат: 8 (999) 123-45-67"
                        required
                        class="input-field"
                    />
                </div>

                <div class="input-group">
                    <input 
                        placeholder="Пароль" 
                        type="password" 
                        class="input-field"
                        name="password"
                        minlength="8"
                        required
                    />
                </div>
                
                <div class="input-group">
                    <input 
                        placeholder="Повторите пароль" 
                        type="password" 
                        class="input-field"
                        name="confirmPassword"
                        minlength="8"
                        required
                    />
                </div>
                
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            class="checkbox-input" 
                            name="personalData"
                            required
                        />
                        <span class="checkbox-text">Я соглашаюсь на обработку персональных данных *</span>
                    </label>
                    
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            class="checkbox-input" 
                            name="privacyPolicy"
                            required
                        />
                        <span class="checkbox-text">Я соглашаюсь с Политикой Конфиденциальности этого сайта *</span>
                    </label>
                    
                    <label class="checkbox-label">
                        <input 
                            type="checkbox" 
                            class="checkbox-input" 
                            name="notifications"
                        />
                        <span class="checkbox-text">Я соглашаюсь на получение уведомлений на почту</span>
                    </label>
                </div>

                <div id="message" style="display: none; margin-bottom: 15px; padding: 10px; border-radius: 5px;"></div>

                <button type="submit" class="submit-btn">Зарегистрироваться</button>
                
                <div class="login-section">
                    <span class="login-text">Уже есть аккаунт? </span>
                    <a href="Authorization.html" class="login-link">Войти!</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                name: formData.get('name'),
                surname: formData.get('surname'),
                patronymic: formData.get('patronymic'),
                login: formData.get('login'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                password: formData.get('password'),
                personalData: formData.get('personalData') === 'on',
                privacyPolicy: formData.get('privacyPolicy') === 'on',
                notifications: formData.get('notifications') === 'on'
            };

            // Валидация ФИО (только русские символы)
            const cyrillicRegex = /^[А-Яа-яЁё\s\-]+$/;
            if (!cyrillicRegex.test(data.name)) {
                showMessage('Имя должно содержать только русские буквы, пробелы и дефисы', 'error');
                return;
            }

            if (!cyrillicRegex.test(data.surname)) {
                showMessage('Фамилия должна содержать только русские буквы, пробелы и дефисы', 'error');
                return;
            }

            if (data.patronymic && !cyrillicRegex.test(data.patronymic)) {
                showMessage('Отчество должно содержать только русские буквы, пробелы и дефисы', 'error');
                return;
            }

            // Валидация логина (только английские символы и цифры, минимум 6)
            const loginRegex = /^[A-Za-z0-9]{6,}$/;
            if (!loginRegex.test(data.login)) {
                showMessage('Логин должен содержать только английские буквы и цифры, минимум 6 символов', 'error');
                return;
            }

            // Проверка паролей
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            
            if (password !== confirmPassword) {
                showMessage('Пароли не совпадают', 'error');
                return;
            }

            if (password.length < 8) {
                showMessage('Пароль должен содержать минимум 8 символов', 'error');
                return;
            }

            // Валидация email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(data.email)) {
                showMessage('Неверный формат email', 'error');
                return;
            }

            // Валидация телефона
            const phoneRegex = /^8\s?\(\d{3}\)\s?\d{3}-\d{2}-\d{2}$/;
            if (!phoneRegex.test(data.phone)) {
                showMessage('Неверный формат телефона. Используйте формат: 8 (999) 123-45-67', 'error');
                return;
            }

            try {
                const response = await fetch('http://localhost:3006/reg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('Регистрация прошла успешно! Автоматический вход...', 'success');
                    
                    // Автоматический вход после регистрации
                    try {
                        const loginResponse = await fetch('http://localhost:3006/auth', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                email: data.email,
                                password: data.password
                            })
                        });

                        const loginResult = await loginResponse.json();

                        if (loginResult.success) {
                            // Сохраняем данные пользователя
                            localStorage.setItem('user', JSON.stringify(loginResult.user));
                            localStorage.setItem('isAuthenticated', 'true');
                            localStorage.setItem('userId', loginResult.user.user_id);
                            localStorage.setItem('userName', loginResult.user.name);
                            localStorage.setItem('userEmail', loginResult.user.email);

                            console.log('✅ Автоматический вход выполнен:', loginResult.user);
                            
                            // Очистка формы
                            document.getElementById('registrationForm').reset();
                            
                            // Перенаправление на главную страницу
                            setTimeout(() => {
                                window.location.href = 'Main.html';
                            }, 2000);
                        } else {
                            // Если автоматический вход не удался
                            localStorage.setItem('isAuthenticated', 'true');
                            localStorage.setItem('userId', result.userId);
                            showMessage('Регистрация успешна! Войдите в систему.', 'success');
                            setTimeout(() => {
                                window.location.href = 'Authorization.html';
                            }, 2000);
                        }
                    } catch (loginError) {
                        console.error('Ошибка автоматического входа:', loginError);
                        localStorage.setItem('userId', result.userId);
                        showMessage('Регистрация успешна! Войдите в систему.', 'success');
                        setTimeout(() => {
                            window.location.href = 'Authorization.html';
                        }, 2000);
                    }
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showMessage('Ошибка соединения с сервером', 'error');
            }
        });

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.style.display = 'block';
            messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
            messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            messageDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
        }

        // Маска для телефона (формат 8 (999) 123-45-67)
        document.getElementById('phone').addEventListener('input', function(e) {
            let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
            e.target.value = (x[1] ? x[1] : '') + (x[2] ? ' (' + x[2] : '') + (x[3] ? ') ' + x[3] : '') + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
        });

        // Проверка авторизации при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            const isAuthenticated = localStorage.getItem('isAuthenticated');
            if (isAuthenticated === 'true') {
                console.log('Пользователь уже авторизован');
                // Можно добавить редирект или скрыть форму
            }
        });

        // Валидация в реальном времени
        document.querySelector('input[name="name"]').addEventListener('input', function(e) {
            const value = e.target.value;
            const regex = /^[А-Яа-яЁё\s\-]*$/;
            if (!regex.test(value)) {
                this.style.borderColor = 'red';
            } else {
                this.style.borderColor = '';
            }
        });

        document.querySelector('input[name="surname"]').addEventListener('input', function(e) {
            const value = e.target.value;
            const regex = /^[А-Яа-яЁё\s\-]*$/;
            if (!regex.test(value)) {
                this.style.borderColor = 'red';
            } else {
                this.style.borderColor = '';
            }
        });

        document.querySelector('input[name="login"]').addEventListener('input', function(e) {
            const value = e.target.value;
            const regex = /^[A-Za-z0-9]*$/;
            if (!regex.test(value)) {
                this.style.borderColor = 'red';
            } else {
                this.style.borderColor = '';
            }
        });
    </script>
</body>
</html>